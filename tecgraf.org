#+title: tecgraf.org
#+1author: kenjirofukuda@gmail.com
#+options: toc:nil num:nil ^:nil ^:{}
#+STARTUP: content
#+HTML_HEAD_EXTRA: <style> .figure p {text-align: left;}</style>
#+HTML_HEAD_EXTRA: <script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js"></script>

* Links
- IUP :: https://www.tecgraf.puc-rio.br/iup/
- CD :: https://www.tecgraf.puc-rio.br/cd/
- IM :: https://www.tecgraf.puc-rio.br/im/
- TECMAKE :: https://www.tecgraf.puc-rio.br/tecmake/en/main.html
- Lua :: https://luabinaries.sourceforge.net/download.html
  
* current SVN version

| im   | r820  |
| cd   | r901  |
| ftgl | r901  |
| iup  | r5971 |

#+begin_src bash :results output :tangle ./bin/hello_world2 :tangle-mode (identity #o755) :shebang #!/usr/bin/env bash
  echo 'Hello World!'
#+end_src


* Setup environment variable
#+begin_src bash :results output
  # set -evu
  err_cnt=0
  [ -z "${TECGRAF_REPO_ROOT:=}" ]  && echo "ERROR: Environment variable not set: TECGRAF_REPO_ROOT" && ((err_cnt++))
  [ -z "${TECTOOLS_HOME:=}" ]      && echo "ERROR: Environment variable not set: TECTOOLS_HOME"     && ((err_cnt++))
  echo err_cnt=$err_cnt
  [[ "$err_cnt" -gt 0 ]] && exit 1
  echo "TECGRAF_REPO_ROOT=${TECGRAF_REPO_ROOT}"
  echo "    TECTOOLS_HOME=${TECTOOLS_HOME}"
  exit 0
#+end_src


* TARGET
** TARGET = GTK
#+begin_src bash :results output 
  cat <<EOM > /tmp/target.env
  export PKG_CONFIG_PATH=
  export REMOTE_IUP_GO_REPO="https://github.com/gen2brain/iup-go.git"
  export LOCAL_IUP_GO_REPO="${TECTOOLS_HOME}/iup-go"

  export USE_GTK=Yes
  export USE_GTK3=Yes
  export USE_MOTIF=
  export USE_X11=
  export EXCLUDE_TARGETS="cdpdf cdluapdf5"
  EOM
#+end_src


** TARGET = MOTIF
#+begin_src bash 
  cat <<EOM > /tmp/target.env
  export PKG_CONFIG_PATH=
  export REMOTE_IUP_GO_REPO="https://github.com/gen2brain/iup-go.git"
  export LOCAL_IUP_GO_REPO="${TECTOOLS_HOME}/iup-go"
  
  export USE_GTK=
  export USE_GTK3=
  export USE_MOTIF=Yes
  export USE_X11=Yes
  export EXCLUDE_TARGETS="cdpdf cdluapdf5 iupweb iup_scintilla iupvled" 
  EOM
#+end_src


* Scripts
** download_tecgraf_lua
#+begin_src bash :results output :tangle ./bin/download_tecgraf_lua :tangle-mode (identity #o755) :shebang #!/usr/bin/env bash
  set -evu
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env
  SLV=$(echo "$USE_LUA_VERSION" | tr -d '.')
  # echo "$SLV"
  mkdir -p "${TECTOOLS_HOME}"
  lua_dir="${TECTOOLS_HOME}/lua${SLV}"
  if [ ! -d "$lua_dir" ]; then

      SRC_URL="https://sourceforge.net/projects/luabinaries/files/5.1.5/Docs%20and%20Sources/lua5_1_5_Sources.tar.gz/download"
      if [ "${USE_LUA_VERSION}" == "5.4" ]; then
	SRC_URL="https://sourceforge.net/projects/luabinaries/files/5.4.2/Docs%20and%20Sources/lua-5.4.2_Sources.tar.gz/download"
      fi
      if [ "${USE_LUA_VERSION}" == "5.3" ]; then
	SRC_URL="https://sourceforge.net/projects/luabinaries/files/5.3.6/Docs%20and%20Sources/lua-5.3.6_Sources.tar.gz/download"
      fi
      if [ "${USE_LUA_VERSION}" == "5.2" ]; then
	SRC_URL="https://sourceforge.net/projects/luabinaries/files/5.2.4/Docs%20and%20Sources/lua-5.2.4_Sources.tar.gz/download"
      fi
      basename=$(echo "${SRC_URL}" | cut -f 9 -d '/')
      echo "$basename"
      dest_dir="${TECGRAF_REPO_ROOT}/archives"
      dest_path="${dest_dir}/${basename}"
      if [ ! -f "${dest_path}" ]; then
	mkdir -p "${dest_dir}"
	curl -L -o "${dest_path}" "${SRC_URL}"
      fi
      tar -xzf "${dest_path}" -C "${TECTOOLS_HOME}"
  fi
  cd "${lua_dir}/src"
  make -f Makefile.tecmake lualib
#+end_src

** donwload_svn_pkg
#+begin_src bash :results output :tangle ./bin/download_svn_pkg :tangle-mode (identity #o755) :shebang #!/usr/bin/env bash
  set -eu
  if [ "$#" -le 2 ]; then
      echo "usage: $(basename $0): {im|ftgl|cd|iup} {repository} {revision}"
      exit 1
  fi

  if [ -z "${TECTOOLS_HOME}:=" ]; then
      echo "Environment variable not set: TECTOOLS_HOME"
      exit 1
  fi
  if [ -z "${TECGRAF_REPO_ROOT}:=" ]; then
      echo "Environment variable not set: TECGRAF_REPO_ROOT"
      exit 1
  fi
  pkg="$1"
  repo="$2"
  revn="$3"
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env

  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env
  mkdir -p "${TECTOOLS_HOME}"
  if [ -d "${TECTOOLS_HOME}/${pkg}" ]; then
      echo "WARNING: ${pkg} already checkuout."
  else
      cd "${TECTOOLS_HOME}"
      echo svn checkout -r"${revn}" "${repo}" "${pkg}"
  fi
  exit 0
#+end_src

** patch_pkg
#+begin_src bash :results output :tangle ./bin/patch_pkg :tangle-mode (identity #o755) :shebang #!/usr/bin/env bash
  if [ "$#" -eq 0 ]; then
      echo "usage: $(basename $0): {im|ftgl|cd|iup}"
      exit 1
  fi

  if [ -z "${TECTOOLS_HOME}:=" ]; then
      echo "Environment variable not set: TECTOOLS_HOME"
      exit 1
  fi
  if [ -z "${TECGRAF_REPO_ROOT}:=" ]; then
      echo "Environment variable not set: TECGRAF_REPO_ROOT"
      exit 1
  fi
  pkg=$1
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env

  if [ ! -d "${TECTOOLS_HOME}/${pkg}" ]; then
      echo "ERROR: ${pkg} not found."
      exit 1
  fi
  patch_file="${TECGRAF_REPO_ROOT}/patches/${pkg}.svn.diff"
  if [ ! -f "$patch_file" ]; then
      echo "ERROR: patchfile not found. $(basename $patch_file)"
      exit 1
  fi
  cd "${TECTOOLS_HOME}/${pkg}"
  if  ls ./src/*.rej &> /dev/null  ; then
      echo "WARNING: already patch applyied. and Fail"
      exit 1
  fi
  if [ -f .patch.done ]; then
      echo "WARNING: already patch applyied."
      exit 0
  fi
  patch -p0 < "$patch_file" && touch .patch.done 
  exit 0
#+end_src
** clean_pkg
#+begin_src bash :results output :tangle ./bin/clean_pkg :tangle-mode (identity #o755) :shebang #!/usr/bin/env bash
  #set -eu
  if [ "$#" -eq 0 ]; then
      echo "usage: $(basename $0): {im|ftgl|cd|iup}"
      exit 1
  fi

  if [ -z "${TECTOOLS_HOME}:=" ]; then
      echo "Environment variable not set: TECTOOLS_HOME"
      exit 1
  fi
  if [ -z "${TECGRAF_REPO_ROOT}:=" ]; then
      echo "Environment variable not set: TECGRAF_REPO_ROOT"
      exit 1
  fi
  pkg=$1
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env

  if [ ! -d "${TECTOOLS_HOME}/${pkg}" ]; then
      echo "ERROR: ${pkg} not found."
      exit 1
  fi
  cd  ${TECTOOLS_HOME}/${pkg}/ && find . -type d -name "dep" -exec rm -rf \{\} \;
  cd  ${TECTOOLS_HOME}/${pkg}/src/ && make -f ../tecmake.mak clean clean-extra
  cd  ${TECTOOLS_HOME}/${pkg}/ && rm -rf obj lib
      #+end_src

** build_pkg
#+begin_src bash :results output :tangle ./bin/build_pkg :tangle-mode (identity #o755) :shebang #!/usr/bin/env bash
  set -ev
  if [ "$#" -eq 0 ]; then
      echo "usage: $(basename $0): {im|ftgl|cd|iup}"
      exit 1
  fi

  if [ -z "${TECTOOLS_HOME}:=" ]; then
      echo "Environment variable not set: TECTOOLS_HOME"
      exit 1
  fi
  if [ -z "${TECGRAF_REPO_ROOT}:=" ]; then
      echo "Environment variable not set: TECGRAF_REPO_ROOT"
      exit 1
  fi
  pkg=$1
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env

  if [ ! -d "${TECTOOLS_HOME}/${pkg}" ]; then
      echo "ERROR: ${pkg} not found."
      exit 1
  fi
  cd "${TECTOOLS_HOME}/${pkg}"
  debug_tec_uname
  env | egrep  '(LUA|TEC|EXCLUDE_)'
#  make -e -j$(nproc) &> /tmp/${pkg}.log
  make -e &> /tmp/${pkg}.log
#+end_src

** backup_target_pkg
#+begin_src bash :results output :tangle ./bin/backup_target_pkg :tangle-mode (identity #o755) :shebang #!/usr/bin/env bash
  if [ "$#" -eq 0 ]; then
      echo "usage: $(basename $0): {im|ftgl|cd|iup}"
      exit 1
  fi

  if [ -z "$TECTOOLS_HOME" ]; then
      echo "Environment variable not set: TECTOOLS_HOME"
      exit 1
  fi
  if [ -z "$TECGRAF_REPO_ROOT" ]; then
      echo "Environment variable not set: TECGRAF_REPO_ROOT"
      exit 1
  fi

  pkg=$1
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env
  dir="${TECTOOLS_HOME}/${pkg}"
  if [ ! -d "$dir" ]; then
      echo "ERROR: directory not found ${dir}"
      exit 1
  fi

  cd "$dir"
  if [ -f ./tec_uname ]; then
      . ./tec_uname
      ComputeTecUname
      ComputeSystemPaths
      ComputeLuaVersion
  else
      TEC_UNAME=$(ls lib)
  fi
  # debug_tec_uname.sh
  baselib="./lib/$TEC_UNAME"
  # echo $baselib
  # env | grep USE_ | sort
  basename=""
  so_dir=""
  if [[ ! -z  "$USE_MOTIF"  ]]; then
      basename="${pkg}_motif"
      so_dir="${TECGRAF_REPO_ROOT}/_so/motif/${pkg}"
  fi
  if [[ ! -z  "$USE_GTK"  ]]; then
      basename="${pkg}_gtk"
      so_dir="${TECGRAF_REPO_ROOT}/_so/gtk/${pkg}"
  fi
  echo $basename
  if [[  -z "$basename" ]]; then
      echo "ERROR: invalid target"
      exit 1
  fi
  echo $baselib
  tar -czvf /tmp/$basename.gz  -C $baselib .
  mkdir -p "$so_dir"
  cd "$so_dir"
  tar -zxvf /tmp/$basename.gz
  exit 0
#+end_src

* LUA
基本的に、コマンドの実行自身はディストリビューションの標準パッケージンを使用する。
ここで必要なのはオブジェクトファイル群である。

- https://sourceforge.net/projects/luabinaries/files/5.4.2/Docs%20and%20Sources/lua-5.4.2_Sources.tar.gz/download
** lua download
#+begin_src bash :results output
  download_tecgraf_lua
#+end_src

** シンボリックリンクによる不具合回避
サフィックス命名規則にブレが有り、実態と一致していないところがあるのでシンボリックリンクでカバーする。
version 5.4の場合

| 実在             | /usr/bin/lua5.4 |
| スクリプトが要求 | /usr/bin/lua54  |

babel におけるsudoの不具合回避がまだ十分ではありません。
実行結果を端末にペーストして実行してください。

#+begin_src bash :results output
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env
  if [ -z "${USE_LUA_VERSION}" ]; then
      echo "Environment variable not set: USE_LUA_VERSION"
      exit 1
  fi
  SLV=$(echo "$USE_LUA_VERSION" | tr -d '.')
  SRC_CMD="lua${USE_LUA_VERSION}"
  DST_CMD="lua${SLV}"
  SRC_PATH="$(command -v $SRC_CMD)"
  DST_PATH="$(dirname $SRC_PATH)/${DST_CMD}"
  if ! command -v $SRC_CMD &> /dev/null; then
     echo "command not found $DST_CMD"
     exit 1
  fi
  if command -v $DST_CMD &> /dev/null; then
     echo "already exists $DST_CMD"
     exit 1
  fi
  echo sudo ln -s "${SRC_PATH}" "${DST_PATH}"
#+end_src

* IM
- @see https://www.tecgraf.puc-rio.br/im/en/guide.html

** svn install
- @see https://www.tecgraf.puc-rio.br/im/en/svn.html
#+begin_src bash results output
  download_svn_pkg im "svn://svn.code.sf.net/p/imtoolkit/im/trunk/im" 820
#+end_src


#+begin_src bash 
env | grep USE_ | sort
#+end_src

** patch im
#+begin_src bash :results output 
  patch_pkg im
#+end_src

** clean im
#+begin_src bash 
  clean_pkg im
      #+end_src

** build im
- lua-5.{x}
- liblua-5.{x}-dev
- libfftw3-dev
#+begin_src bash :results output
  build_pkg im
#+end_src

** backup im
#+begin_src bash 
  backup_target_pkg im
#+end_src

* CD
- @see https://www.tecgraf.puc-rio.br/cd/en/guide.html
** ftgl
- libglu1-mesa-dev:  GL/glu.h not found
*** install
#+begin_src bash
  download_svn_pkg ftgl "svn://svn.code.sf.net/p/canvasdraw/cd/trunk/ftgl" 901
#+end_src
*** patch to ftgl
#+begin_src bash
  patch_pkg ftgl
#+end_src

*** build ftgl
#+begin_src bash :results output
  build_pkg ftgl
#+end_src

*** clean ftgl
#+begin_src bash
  clean_pkg ftgl
      #+end_src

*** backup ftgl
#+begin_src bash
  backup_target_pkg ftgl
#+end_src

*** install ftgl

#+begin_src bash
  set -ve
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env
  if [ ! -d "${TECTOOLS_HOME}/ftgl" ]; then
      echo "ftgl not found."
      exit 1
  fi
  cd "${TECTOOLS_HOME}/ftgl"
  make
  if [ ! -f "${TECTOOLS_HOME}/ftgl/lib/${TEC_UNAME}/libftgl.a" ]; then
      echo "libftgl.a not found."
      exit 1
  fi
  if [ ! -f "${TECTOOLS_HOME}/ftgl/lib/${TEC_UNAME}/libftgl.so" ]; then
      echo "libftgl.so not found."
      exit 1
  fi
  sudo -E cp "${TECTOOLS_HOME}/ftgl/lib/${TEC_UNAME}/libftgl.a" /usr/lib/
  sudo -E cp "${TECTOOLS_HOME}/ftgl/lib/${TEC_UNAME}/libftgl.so" /usr/lib/
#+end_src


** cd
*** install
#+begin_src bash
  download_svn_pkg cd "svn://svn.code.sf.net/p/canvasdraw/cd/trunk/cd" 901
#+end_src

*** patch to cd
#+begin_src bash :results output
  patch_pkg cd
#+end_src

*** clean cd
#+begin_src bash :results output
  clean_pkg cd
      #+end_src

*** build cd
#+begin_src bash :results output
  build_pkg cd
#+end_src

*** backup cd
#+begin_src bash :results output
  backup_target_pkg cd
#+end_src

* IUP
- @see https://www.tecgraf.puc-rio.br/iup/en/guide.html

** download iup
- @see https://www.tecgraf.puc-rio.br/iup/en/svn.html
#+begin_src bash :results output
  download_svn_pkg iup "svn://svn.code.sf.net/p/iup/iup/trunk/iup" 5971
#+end_src

** patch to iup
#+begin_src bash :results output
  patch_pkg iup
  #+end_src

** install iup-go
- https://github.com/gen2brain/iup-go.git
#+begin_src bash :results output
  set -ev
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env
  if [ -d "${LOCAL_IUP_GO_REPO}" ]; then
      echo "iup-go already checkuout."
  else
      cd "${TECTOOLS_HOME}"
      git clone "${REMOTE_IUP_GO_REPO}"
  fi
#+end_src

** overwrite iup-go
#+begin_src bash :results output
  set -ev
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env
  SRC="${TECTOOLS_HOME}/iup-go/iup/external/include"
  DST="${TECTOOLS_HOME}/iup/include"
  if [ ! -d "$SRC" ]; then
      echo "not found $SRC"
      exit 1
  fi
  if [ ! -d "$DST" ]; then
      echo "not found $DST"
      exit 1
  fi
  rsync -av $SRC/ $DST/
#+end_src



#+begin_src bash
  set -ev
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  . /tmp/target.env
  SRC="${TECTOOLS_HOME}/iup-go/iup/external/src"
  DST="${TECTOOLS_HOME}/iup/src"
  if [ ! -d "$SRC" ]; then
      echo "not found $SRC"
      exit 1
  fi
  if [ ! -d "$DST" ]; then
      echo "not found $DST"
      exit 1
  fi
  rsync -av $SRC/ $DST/
#+end_src

** fix: src/libjasper2/base/jas_stream.c
#+begin_src c
  // add: kenjirofukuda@gmail.com
  #define JAS_HAVE_UNISTD_H 1
#+end_src

** install libjasper
#+begin_src bash :results output
  # void linux
  sudo xbps-install jasper jasper-devel libjasper
  sudo xbps-install lua lua-devel
#+end_src

** clean iup
#+begin_src bash :results output
  clean_pkg iup
#+end_src

** build iup
#+begin_src bash :results output
  build_pkg iup
#+end_src

** backup iup
#+begin_src bash :results output
  backup_target_pkg iup
#+end_src
