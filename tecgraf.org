#+title: tecgraf.org
#+1author: kenjirofukuda@gmail.com
#+options: toc:nil num:nil ^:nil ^:{}
#+HTML_HEAD_EXTRA: <style> .figure p {text-align: left;}</style>
#+HTML_HEAD_EXTRA: <script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js"></script>

* Links
- IUP :: https://www.tecgraf.puc-rio.br/iup/
- CD :: https://www.tecgraf.puc-rio.br/cd/
- IM :: https://www.tecgraf.puc-rio.br/im/
- TECMAKE :: https://www.tecgraf.puc-rio.br/tecmake/en/main.html
- Lua :: https://luabinaries.sourceforge.net/download.html
  
* current SVN version

| im   | r820  |
| cd   | r901  |
| ftgl | r901  |
| iup  | r5971 |


* TARGET
** TARGET = GTK
#+begin_src bash :results output 
  cat <<"EOM" > /tmp/target.env
  export REMOTE_IUP_GO_REPO="https://github.com/gen2brain/iup-go.git"
  export LOCAL_IUP_GO_REPO="${TECTOOLS_HOME}/iup-go"
  
  export USE_GTK=Yes
  export USE_GTK3=Yes
  export USE_MOTIF=
  export USE_X11=
  export EXCLUDE_TARGETS="cdpdf cdluapdf5"
  EOM
  cat /tmp/target.env
#+end_src

** TARGET = MOTIF
#+begin_src bash 
  cat <<"EOM" > /tmp/target.env
  export REMOTE_IUP_GO_REPO="https://github.com/gen2brain/iup-go.git"
  export LOCAL_IUP_GO_REPO="${TECTOOLS_HOME}/iup-go"
  
  export USE_GTK=
  export USE_GTK3=
  export USE_MOTIF=Yes
  export USE_X11=Yes
  export EXCLUDE_TARGETS="cdpdf cdluapdf5 iupweb iup_scintilla iupvled" 
  EOM
  cat /tmp/target.env
#+end_src


* LUA
基本的に、コマンドの実行自身はディストリビューションの標準パッケージンを使用する。
ここで必要なのはオブジェクトファイル群である。

- https://sourceforge.net/projects/luabinaries/files/5.4.2/Docs%20and%20Sources/lua-5.4.2_Sources.tar.gz/download

** lua downloads
#+begin_src bash :results output
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  SLV=$(echo $USE_LUA_VERSION | tr -d '.')
  # echo $SLV
  lua_dir="${TECTOOLS_HOME}/lua${SLV}"
  if [ ! -d "$lua_dir" ]; then

      SRC_URL="https://sourceforge.net/projects/luabinaries/files/5.1.5/Docs%20and%20Sources/lua5_1_5_Sources.tar.gz/download"
      if [ "${USE_LUA_VERSION}" == "5.4" ]; then
  	SRC_URL="https://sourceforge.net/projects/luabinaries/files/5.4.2/Docs%20and%20Sources/lua-5.4.2_Sources.tar.gz/download"
      fi
      if [ "${USE_LUA_VERSION}" == "5.3" ]; then
  	SRC_URL="https://sourceforge.net/projects/luabinaries/files/5.3.6/Docs%20and%20Sources/lua-5.3.6_Sources.tar.gz/download"
      fi
      if [ "${USE_LUA_VERSION}" == "5.2" ]; then
  	SRC_URL="https://sourceforge.net/projects/luabinaries/files/5.2.4/Docs%20and%20Sources/lua-5.2.4_Sources.tar.gz/download"
      fi
      basename=$(echo "${SRC_URL}" | cut -f 9 -d '/')
      echo $basename
      dest_dir="${TECGRAF_REPO_ROOT}/archives"
      dest_path="${dest_dir}/${basename}"
      if [ ! -f "${dest_path}" ]; then
  	mkdir -p "${dest_dir}"
  	curl -L -o "${dest_path}" "${SRC_URL}"
      fi
      tar -xzf "${dest_path}" -C "${TECTOOLS_HOME}"
  fi
  cd "${lua_dir}/src"
  make -f Makefile.tecmake lualib
#+end_src


** lua install (deprecated)
#+begin_src bash :results output
  echo deprecated install lua aooficial repository
  echo please install luabinaries version.
  exit 0
  if [ -z "$TECTOOLS_HOME" ]; then
      echo "Environment variable not set: TECTOOLS_HOME"
      exit 1
  fi
  if [ -z "$TECGRAF_REPO_ROOT" ]; then
      echo "Environment variable not set: TECGRAF_REPO_ROOT"
      exit 1
  fi
  LUA_SLV=$(echo $USE_LUA_VERSION | tr -d '.')
  # echo $LUA_SLV
  lua_dir="${TECTOOLS_HOME}/lua${LUA_SLV}"
  if [ -d "$lua_dir" ]; then
      echo "already extracted $(basename $lua_dir)"
      exit 0
  fi
  long_ver=$(lua -v | cut -f2 -d' ')
  echo TODO extract $long_ver
  basename="lua-${long_ver}.tar.gz"
  url="https://www.lua.org/ftp/${basename}"
  echo start download $url
  archive_download_dir="${TECGRAF_REPO_ROOT}/archives"
  archive="$archive_download_dir/${basename}"
  mkdir -p "$archive_download_dir"
  cd "$archive_download_dir"
  if [ -f "$archive" ]; then
      echo "already downloaded $basename"
  else
      curl -O "$url"
      ls -la 
  fi
  mkdir -p "${lua_dir}"
  tar -xzf "${archive}" --strip-components=1 -C "${lua_dir}/"
  exit 0
#+end_src

** シンボリックリンクによる不具合回避
サフィックス命名規則にブレが有り、実態と一致していないところがあるのでシンボリックリンクでカバーする。
version 5.4の場合

| 実在             | /usr/bin/lua5.4 |
| スクリプトが要求 | /usr/bin/lua54  |

#+begin_src bash :results output
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  if [ -z "${USE_LUA_VERSION}" ]; then
      echo "Environment variable not set: USE_LUA_VERSION"
      exit 1
  fi
  SLV=$(echo $USE_LUA_VERSION | tr -d '.')
  SRC_CMD="lua${USE_LUA_VERSION}"
  DST_CMD="lua${SLV}"
  SRC_PATH="$(command -v $SRC_CMD)"
  DST_PATH="$(dirname $SRC_PATH)/${DST_CMD}"
  if ! command -v $SRC_CMD &> /dev/null; then
     echo "command not found $DST_CMD"
     exit 1
  fi
  if command -v $DST_CMD &> /dev/null; then
     echo "already exists $DST_CMD"
     exit 1
  fi
  echo sudo ln -s "${SRC_PATH}" "${DST_PATH}"
#+end_src


** lua build
#+begin_src bash :session tecgraf-session
  if [ -z "$TECTOOLS_HOME" ]; then
      echo "Environment variable not set: TECTOOLS_HOME"
      exit 1
  fi
  if [ -z "$TECGRAF_REPO_ROOT" ]; then
      echo "Environment variable not set: TECGRAF_REPO_ROOT"
      exit 1
  fi
  LUA_SLV=$(echo $USE_LUA_VERSION | tr -d '.')
  # echo $LUA_SLV
  lua_dir="${TECTOOLS_HOME}/lua${LUA_SLV}"
  if [ ! -d "$lua_dir" ]; then
      echo "ERROR: directory not found $lua_dir"
      exit 1
  fi
  echo build
  cd "$lua_dir"
  make
#+end_src


* IM
- @see https://www.tecgraf.puc-rio.br/im/en/guide.html

** svn install
- @see https://www.tecgraf.puc-rio.br/im/en/svn.html
#+begin_src bash 
  mkdir -p "$TECTOOLS_HOME"
  if [ -d "${TECTOOLS_HOME}/im" ]; then
      echo "im already checkuout."
  else
      cd "$TECTOOLS_HOME"
      svn checkout -r820 svn://svn.code.sf.net/p/imtoolkit/im/trunk/im im
  fi
  exit 0
#+end_src


#+begin_src bash 
env | grep USE_ | sort
#+end_src

** patch to im
#+begin_src bash 
  if [ ! -d "${TECTOOLS_HOME}/im" ]; then
      echo "im not found."
      exit 1
  fi
  patch_file="${TECGRAF_REPO_ROOT}/patches/im.svn.diff"
  if [ ! -f "$patch_file" ]; then
      echo "patchfile not found."
      exit 1
  fi
  cd "${TECTOOLS_HOME}/im"
  patch -p0 < "$patch_file"
  exit 0
#+end_src


** clean im
#+begin_src bash 
  cd  $TECTOOLS_HOME/im && rm -rf obj lib
#+end_src


** build im
#+begin_src bash :results list
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  cd  $TECTOOLS_HOME/im || echo not found im
  debug_tec_uname
  env | egrep  '(LUA|TEC)'
  make -e -j$(nproc) &> /tmp/im.log
#+end_src


** backup im
#+begin_src bash 
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  backup_tecgraf_build_result im
#+end_src


* CD
- @see https://www.tecgraf.puc-rio.br/cd/en/guide.html
** svn install
- @see https://www.tecgraf.puc-rio.br/cd/en/svn.html
#+begin_src bash
  if [ -d $TECTOOLS_HOME/cd ]; then
      echo "cd already checkuout."
  else
      cd $TECTOOLS_HOME
      svn checkout -r901 svn://svn.code.sf.net/p/canvasdraw/cd/trunk/cd cd 
  fi

  if [ -d $TECTOOLS_HOME/ftgl ]; then
      echo "ftgl already checkuout."
  else
      cd $TECTOOLS_HOME
      svn checkout -r901 svn://svn.code.sf.net/p/canvasdraw/cd/trunk/ftgl ftgl
  fi
  exit 0
#+end_src


** patch to ftgl
#+begin_src bash
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  if [ ! -d "${TECTOOLS_HOME}/ftgl" ]; then
      echo "ftgl not found."
      exit 1
  fi
  patch_file="${TECGRAF_REPO_ROOT}/patches/ftgl.svn.diff"
  if [ ! -f "$patch_file" ]; then
      echo "patchfile not found."
      exit 1
  fi
  cd "${TECTOOLS_HOME}/ftgl"
  patch -p0 < "$patch_file"
  exit 0
#+end_src


** clean ftgl
#+begin_src bash
  . "${TECGRAF_REPO_ROOT}/bin/bashrc_tecgraf"
  cd  $TECTOOLS_HOME/ftgl && rm -rf obj lib
#+end_src


** build ftgl
#+begin_src bash :results list :session tecgraf-session
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  env | egrep  '(LUA|TEC)'
  cd  $TECTOOLS_HOME/ftgl || echo not found ftgl
  debug_tec_uname
  make -e -j$(nproc) &> /tmp/ftgl.log
#+end_src


** backup ftgl
#+begin_src bash 
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  backup_tecgraf_build_result ftgl
#+end_src


** install ftgl

#+begin_src bash
  set -ve
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  if [ ! -d $TECTOOLS_HOME/ftgl ]; then
      echo "ftgl not found."
      exit 1
  fi
  cd $TECTOOLS_HOME/ftgl
  make
  if [ ! -f $TECTOOLS_HOME/ftgl/lib/Linux612_64/libftgl.a ]; then
      echo "libftgl.a not found."
      exit 1
  fi
  if [ ! -f $TECTOOLS_HOME/ftgl/lib/Linux612_64/libftgl.so ]; then
      echo "libftgl.so not found."
      exit 1
  fi
  sudo -E cp $TECTOOLS_HOME/ftgl/lib/Linux612_64/libftgl.a /usr/lib/
  sudo -E cp $TECTOOLS_HOME/ftgl/lib/Linux612_64/libftgl.so /usr/lib/
#+end_src


** patch to cd
#+begin_src bash
  set -ve
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  if [ ! -d "${TECTOOLS_HOME}/cd" ]; then
      echo "cd not found."
      exit 1
  fi
  patch_file="${TECGRAF_REPO_ROOT}/patches/cd.svn.diff"
  if [ ! -f "$patch_file" ]; then
      echo "patchfile not found."
      exit 1
  fi
  cd "${TECTOOLS_HOME}/cd"
  patch -p0 < "$patch_file"
  exit 0
#+end_src


** clean cd
#+begin_src bash
  set -ve
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  cd  $TECTOOLS_HOME/cd && rm -rf obj lib
#+end_src


** build cd
#+begin_src bash :results output
  set -ve
  pkg-config --modversion gtk+-3.0 
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  env | egrep  '(LUA|TEC|EXCLUDE)'
  cd  $TECTOOLS_HOME/cd || (echo not found cd; exit 1)
  make -e -j$(nproc) &> /tmp/cd.log
#+end_src


** backup cd
#+begin_src bash :results output
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  backup_tecgraf_build_result cd
#+end_src

* IUP
- @see https://www.tecgraf.puc-rio.br/iup/en/guide.html

** svn install
- @see https://www.tecgraf.puc-rio.br/iup/en/svn.html
#+begin_src bash
  if [ -d "${TECTOOLS_HOME}/iup" ]; then
      echo "iup already checkuout."
  else
      cd "$TECTOOLS_HOME"
      svn checkout -r5971 svn://svn.code.sf.net/p/iup/iup/trunk/iup iup
  fi
  exit 0
#+end_src


** patch to iup
#+begin_src bash
  set -ve
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  if [ ! -d "${TECTOOLS_HOME}/iup" ]; then
      echo "iup not found."
      exit 1
  fi
  patch_file="${TECGRAF_REPO_ROOT}/patches/iup.svn.diff"
  if [ ! -f "$patch_file" ]; then
      echo "patchfile not found."
      exit 1
  fi
  cd "${TECTOOLS_HOME}/iup"
  patch -p0 < "$patch_file"
  exit 0
#+end_src

** install iup-go
- https://github.com/gen2brain/iup-go.git
#+begin_src bash
  set -ev
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  if [ -d "${LOCAL_IUP_GO_REPO}" ]; then
      echo "iup-go already checkuout."
  else
      cd "${TECTOOLS_HOME}"
      git clone "${REMOTE_IUP_GO_REPO}"
  fi
#+end_src


** overwrite iup-go
#+begin_src bash
  set -ev
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  SRC="${TECTOOLS_HOME}/iup-go/iup/external/include"
  DST="${TECTOOLS_HOME}/iup/include"
  if [ ! -d "$SRC" ]; then
      echo "not found $SRC"
      exit 1
  fi
  if [ ! -d "$DST" ]; then
      echo "not found $DST"
      exit 1
  fi
  rsync -av $SRC/ $DST/
#+end_src



#+begin_src bash
  set -ev
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  SRC="${TECTOOLS_HOME}/iup-go/iup/external/src"
  DST="${TECTOOLS_HOME}/iup/src"
  if [ ! -d "$SRC" ]; then
      echo "not found $SRC"
      exit 1
  fi
  if [ ! -d "$DST" ]; then
      echo "not found $DST"
      exit 1
  fi
  rsync -av $SRC/ $DST/
#+end_src


** fix: src/libjasper2/base/jas_stream.c
#+begin_src c
// add: kenjirofukuda@gmail.com
#define JAS_HAVE_UNISTD_H 1
#+end_src

** install libjasper
#+begin_src bash
  # void linux
  sudo xbps-install jasper jasper-devel libjasper
  sudo xbps-install lua lua-devel
#+end_src

** clean iup
#+begin_src bash
  set -ev
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  cd  $TECTOOLS_HOME/iup && rm -rf obj lib
#+end_src


** build iup
#+begin_src bash :results output
  set -ev
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  cd  $TECTOOLS_HOME/iup || (echo not found iup; exit 1)
  pwd
  env | egrep  '(LUA|TEC)'
  rm -rf /tmp/iup.log
  cd  $TECTOOLS_HOME/iup && make -e -j$(nproc) &> /tmp/iup.log
#+end_src


** backup iup
#+begin_src bash :results output
  set -ev
  . "$TECGRAF_REPO_ROOT/bin/bashrc_tecgraf"
  . /tmp/target.env
  backup_tecgraf_build_result iup
#+end_src
